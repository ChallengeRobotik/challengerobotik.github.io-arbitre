<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me de Scoring Robotique ArbiBot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Base Styles */
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333333;
            --header-border: #cccccc;
            --button-bg: #007bff;
            --button-text: #ffffff;
            --button-hover: #0056b3;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.4s, color 0.4s;
        }

        .card {
            background-color: var(--card-bg);
            padding: 25px;
            margin: 20px auto;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            transition: background-color 0.4s, box-shadow 0.4s;
        }

        header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--header-border);
            background-color: var(--card-bg);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        .logo-svg {
            height: 40px;
            width: auto;
            margin-right: 15px;
        }
        /* Styles SVG pour les th√®mes */
        .logo-svg .st0 { fill: #007BFF; }
        .logo-svg .st1 { fill: #FFC107; }
        .logo-svg .st2 { fill: #FFFFFF; }


        button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s, color 0.3s;
            margin-left: 10px;
            background-color: var(--button-bg);
            color: var(--button-text);
        }

        button:hover {
            transform: translateY(-1px);
            background-color: var(--button-hover);
        }

        input[type="text"], input[type="password"], input[type="number"], select {
            padding: 10px;
            margin: 8px 0;
            border: 1px solid var(--header-border);
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        /* D√©sactiver le style de l'input d√©sactiv√© pour la sym√©trie */
        input:disabled {
            opacity: 1; 
            background-color: var(--card-bg); 
            color: var(--text-color); 
            cursor: default;
        }

        h1, h2, h3 { margin-top: 0; color: var(--text-color); }

        .error-message { color: red; font-weight: bold; }
        .success-message { color: green; font-weight: bold; }

        /* --- GRILLES DE SCORING --- */
        .scoring-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .team-scoring {
            padding: 20px;
            border-radius: 8px;
            transition: background-color 0.4s; 
            display: flex;
            flex-direction: column;
        }
        
        .team-scoring h3 {
            text-align: center;
        }

        #inputsA, #inputsB {
            flex-grow: 1; 
        }
        
        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed var(--header-border);
        }
        .score-item:last-child { border-bottom: none; }

        .score-summary {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            border-top: 2px solid var(--header-border);
            text-align: center;
        }

        .final-validation-area {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--header-border);
            text-align: center;
        }
        
        .final-validation-area button {
            width: auto;
            margin: 5px;
        }

        /* --- HISTORIQUE DES MATCHS --- */
        #history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #history-table th, #history-table td {
            border: 1px solid var(--header-border);
            padding: 10px;
            text-align: left;
        }
        #history-table th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        .dark-mode #history-table th {
            background-color: #333;
        }
        #history-body tr td:nth-child(2),
        #history-body tr td:nth-child(4) {
            font-weight: bold;
            text-align: center;
        }
        #history-body tr td:nth-child(5) {
            font-weight: 700;
            color: #007bff;
        }


        /* --- Menu P√©nalit√©s Cachable et autres styles --- */
        .penalty-toggle {
            cursor: pointer;
            background-color: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #333;
        }
        .dark-mode .penalty-toggle {
            background-color: #444;
            color: #eee;
        }

        .penalty-content {
            display: none;
            padding: 0 10px;
            border: 1px solid var(--header-border);
            border-radius: 0 0 4px 4px;
        }
        .penalty-content.active {
            display: block;
        }
        #equality-resolution {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid orange;
            border-radius: 8px;
            background-color: #fff3e0;
        }
        .dark-mode #equality-resolution {
            background-color: #5d4037;
            border-color: #ff9800;
        }
        .equality-btn {
            margin-top: 10px;
            width: 48%;
            background-color: orange;
            color: white;
        }
        .equality-btn:hover {
            background-color: darkorange;
        }
        
        /* --- TH√àMES --- */
        /* Fond des √©quipes en mode CLAIR */
        .light-mode .team-A { background-color: rgba(0, 100, 255, 0.1); }
        .light-mode .team-B { background-color: rgba(255, 200, 0, 0.1); }

        /* Fond des √©quipes en mode SOMBRE */
        .dark-mode {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --header-border: #5a7a9a;
            --button-bg: #1abc9c;
            --button-text: #2c3e50;
            --button-hover: #16a085;
        }
        .dark-mode .team-A { background-color: rgba(0, 100, 255, 0.3); }
        .dark-mode .team-B { background-color: rgba(255, 200, 0, 0.3); }
        .dark-mode .logo-svg .st0 { fill: #1abc9c; }
        .dark-mode .logo-svg .st1 { fill: #f1c40f; }
        .dark-mode input:disabled {
            background-color: var(--card-bg); 
            color: var(--text-color); 
        }

        /* Fond des √©quipes en mode D√âGRAD√â ANIM√â */
        @keyframes gradient-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animated-mode {
            --bg-color: #3a1c71;
            --card-bg: #2c3e50;
            --text-color: #ffffff;
            --header-border: #7f8c8d;
            --button-bg: #e74c3c;
            --button-text: #ffffff;
            --button-hover: #c0392b;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient-bg 15s ease infinite;
        }
        .animated-mode .card {
            background-color: rgba(52, 73, 94, 0.9);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .animated-mode .team-A { background-color: rgba(41, 128, 185, 0.5); }
        .animated-mode .team-B { background-color: rgba(243, 156, 18, 0.5); }
        .animated-mode .logo-svg .st0 { fill: #3498db; }
        .animated-mode .logo-svg .st1 { fill: #f39c12; }
        .animated-mode input:disabled {
            background-color: var(--card-bg); 
            color: var(--text-color); 
        }


    </style>
</head>
<body>

    <div id="login-page">
        <div class="card">
            <h1>Connexion Arbitre</h1>
            <p>Saisissez vos codes d'acc√®s manuellement.</p>
            <form id="login-form">
                <input type="text" id="login-id" placeholder="Identifiant" required onfocus="this.removeAttribute('autocomplete');">
                <input type="password" id="login-password" placeholder="Mot de Passe" required onfocus="this.removeAttribute('autocomplete');">
                <button type="submit">Se Connecter</button>
                <p id="login-error" class="error-message"></p>
            </form>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        
        <header>
            <div class="logo-container">
                <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve" class="logo-svg">
                    <style type="text/css">
                        .st0{fill:#007BFF;}
                        .st1{fill:#FFC107;}
                        .st2{fill:#FFFFFF;}
                    </style>
                    <g>
                        <circle class="st0" cx="50" cy="50" r="48"/>
                        <path class="st1" d="M50,8c23.2,0,42,18.8,42,42c0,11.2-4.4,21.4-11.6,29.1L50,50V8z"/>
                        <path class="st2" d="M50,45.8c-2.8,0-5.1-2.3-5.1-5.1c0-2.8,2.3-5.1,5.1-5.1c2.8,0,5.1,2.3,5.1,5.1C55.1,43.5,52.8,45.8,50,45.8z"/>
                        <polygon class="st2" points="50,52 50,75 56.6,68.4 56.6,58.7"/>
                        <polygon class="st2" points="50,52 50,75 43.4,68.4 43.4,58.7"/>
                        <path class="st2" d="M50,15.5c-1.3,0-2.3-1-2.3-2.3c0-1.3,1-2.3,2.3-2.3c1.3,0,2.3,1,2.3,2.3C52.3,14.5,51.3,15.5,50,15.5z"/>
                        <rect x="47.7" y="15.5" class="st2" width="4.6" height="15.8"/>
                    </g>
                </svg>
                <h1>Challenge Robotik 2026</h1>
            </div>
            <div id="theme-switcher">
                <label>Th√®mes :</label>
                <button onclick="setTheme('light')">Clair</button>
                <button onclick="setTheme('dark')">Sombre</button>
                <button onclick="setTheme('animated')">D√©grad√© Anim√©</button>
                <button onclick="logout()" class="logout-btn">D√©connexion</button>
            </div>
        </header>

        <section id="config-section" class="card">
            <h2>Configuration du Match</h2>
            <div class="team-config">
                
                <div class="team-setup">
                    <h3>√âquipe 1 (Bleue)</h3>
                    <select id="teamA-select"></select>
                    <input type="text" id="teamA-custom" placeholder="Ajouter manuellement (Ville/Nom)...">
                </div>

                <div class="team-setup">
                    <h3>√âquipe 2 (Vert)</h3>
                    <select id="teamB-select"></select>
                    <input type="text" id="teamB-custom" placeholder="Ajouter manuellement (Ville/Nom)...">
                </div>
            </div>
            
            <button onclick="randomizeTeams()">Randomiser les √âquipes (√âquilibr√©)</button>
            <button id="validate-teams-btn" onclick="validateTeams()">Valider la Configuration</button>
        </section>

        <section id="scoring-section" class="card" style="display: none;">
            <h2>Saisie des Scores</h2>
            <p class="match-info">Match Actuel : <span id="match-display"></span></p>

            <div class="scoring-grid">
                <div id="score-teamA" class="team-scoring team-A">
                    <h3>√âquipe 1: <span id="nameA-score"></span></h3>
                    <div id="inputsA">
                        </div>
                    <div class="score-summary team-A-summary">Score Actuel: <span id="currentScoreA" data-final-score="0">0</span> pts</div>
                </div>

                <div id="score-teamB" class="team-scoring team-B">
                    <h3>√âquipe 2: <span id="nameB-score"></span></h3>
                    <div id="inputsB">
                        </div>
                    <div class="score-summary team-B-summary">Score Actuel: <span id="currentScoreB" data-final-score="0">0</span> pts</div>
                </div>
            </div>
            
            <div id="equality-resolution" style="display: none;">
                <h4>R√©solution d'√âgalit√© (Acc√®s Sp√©cial)</h4>
                <p>Les scores sont √©gaux. Veuillez d√©terminer le vainqueur du match :</p>
                <button class="equality-btn" onclick="setEqualityWinner('A')">D√©clarer <span id="eq-name-A"></span> Vainqueur</button>
                <button class="equality-btn" onclick="setEqualityWinner('B')">D√©clarer <span id="eq-name-B"></span> Vainqueur</button>
                <button class="equality-btn" onclick="setEqualityWinner('None')">Maintenir √âgalit√© (Match Nul)</button>
            </div>

            <div class="final-validation-area">
                <button id="validate-match-btn" onclick="validateAndSaveScore()">Valider le Score et Publier sur Discord</button>
                <button onclick="downloadMatchResult()">T√©l√©charger le R√©sultat (.txt)</button>
                <p id="validation-message" class="success-message"></p>
            </div>
        </section>
        
        <section id="manual-discord-section" class="card">
            <h2>Envoi de Message Manuel Discord</h2>
            <textarea id="manual-message" placeholder="Tapez votre message ici (ex: Fin de la pause d√©jeuner)..." rows="3"></textarea>
            <button onclick="sendManualDiscordMessage()">Envoyer un message √† Discord</button>
            <p id="manual-message-status" class="success-message"></p>
        </section>

        <section id="history-section" class="card">
            <h2>Historique des Matchs (Local)</h2>
            <table id="history-table">
                <thead>
                    <tr>
                        <th>√âquipe 1</th>
                        <th>Score 1</th>
                        <th>√âquipe 2</th>
                        <th>Score 2</th>
                        <th>Vainqueur</th>
                        <th>Arbitre</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    </tbody>
            </table>
            <button onclick="clearHistory()" class="clear-btn">Effacer l'Historique Local</button>
        </section>
    </div>

    <script>
        // --- 1. CONFIGURATION GLOBALE & S√âCURIT√â ---

        // Webhook Discord (URL fournie par l'utilisateur)
        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1429885227559555213/4lkyLV6pN-L3kztZxNNnawaONtsgX_d300QNO00ynV8QTHsI26b4Yvpuzf-Hmvecejkc";

        // Codes de connexion et Noms R√©els
        const USERS = [
            { login: 'NtHn_9f4Q', name: 'Nathan', isSpecial: false },
            { login: 'BnJm_K2sX', name: 'Benjamin', isSpecial: false },
            { login: 'MlNd_5p3D', name: 'Milandris', isSpecial: false },
            { login: 'MrFr_G8mC', name: 'Mr FRAMBOURT', isSpecial: true },
            { login: 'MxmL_7aJb', name: 'Maximilien', isSpecial: false },
            { login: 'NlNe_B1vY', name: 'Nolane', isSpecial: false },
            { login: 'admin', name: 'Administrateur', isSpecial: true },
        ];
        
        const EQUALITY_ARBITERS = ['admin', 'MrFr_G8mC'];

        // Liste des √©quipes initiales
        const INITIAL_TEAMS = [
            'Cond√© en Brie', 'Neuilly Saint Front', 'Saint Joseph', 
            'Charly Sur Marne', 'Jean Racine', 'Jules Verne'
        ];

        // Bar√®me de Scoring (Identique)
        const SCORING_RULES = {
            actions: [
                { id: 'start', label: 'Robot sorti de zone de d√©part', points: 10, type: 'checkbox' },
                { id: 'astro_in', label: '√âtape 1: Astron. correctement rentr√©', points: 15, type: 'checkbox' },
                { id: 'voyant_allu', label: '√âtape 2: Voyant allum√©', points: 15, type: 'checkbox' },
                { id: 'fusee_rent', label: '√âtape 3: Fus√©e correctement rentr√©e', points: 15, type: 'checkbox' },
                { id: 'leds_allu', label: '√âtape 4: Leds Verts allum√©es', points: 15, type: 'checkbox' },
                { id: 'fusee_sep', label: '√âtape 5: Fus√©e s√©par√©e', points: 15, type: 'checkbox' },
                { id: 'lune_2e', label: 'Position sur arriv√©e:(2e)', points: 10, type: 'checkbox' },
                { id: 'lune_1er', label: 'Position sur arriv√©e:(1er)', points: 25, type: 'checkbox' },


            ],
            penalties: [
                { id: 'replace', label: 'Arbitre replace robot sur ligne (-10 pts)', points: -10, type: 'checkbox' },
                { id: 'faux_dep', label: 'Faux d√©part (-30 pts)', points: -30, type: 'checkbox' },
                { id: 'degrad', label: 'D√©gradation table/√©l√©ment (-30 pts)', points: -30, type: 'checkbox' },
                { id: 'bouge_fin', label: 'Robot bouge √† la fin (-30 pts)', points: -30, type: 'checkbox' },
                { id: 'prep_exc', label: 'Temps de pr√©paration excessif (-20 pts)', points: -20, type: 'checkbox' },
                { id: 'antisport', label: 'Comportement anti-arbitre/fair-play (-50 √† -100 pts)', points: 0, type: 'manual_penalty', min: -100, max: -50 },
                { id: 'forfeit', label: 'FORFAIT', points: 0, type: 'forfeit' }
            ],
            special: [
                { id: 'temps', label: 'Temps R√©alis√© (s)', type: 'time' },
            ]
        };

        const MAX_TIME = 120;
        const MAX_BONUS = 60;

        let currentTeams = { teamA: null, teamB: null };
        let finalWinnerOverride = null;

        // --- 2. GESTION DE L'AUTHENTIFICATION (Identique) ---

        function checkAuth() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                initApp();
            } else {
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        }
        
        function getArbiterName(login) {
            const user = USERS.find(u => u.login === login);
            return user ? user.name : 'Arbitre Inconnu';
        }
        
        function isSpecialArbiter(login) {
            return EQUALITY_ARBITERS.includes(login);
        }

        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const login = document.getElementById('login-id').value;
            const password = document.getElementById('login-password').value;
            const errorMsg = document.getElementById('login-error');

            // Logic for authentication (assuming a standard structure for password checks)
            const user = USERS.find(u => u.login === login);
            let isAuthenticated = false;
            
            if (user) {
                // Simplified password check logic based on previous examples
                if (user.login === 'admin' && password === 'fullaccess') {
                    isAuthenticated = true;
                } else if (user.login === 'MrFr_G8mC' && password === 'T2zN4kQe') {
                    isAuthenticated = true;
                } else if (user.login === 'NtHn_9f4Q' && password === 'P6wL7bZt') {
                    isAuthenticated = true;
                } else if (user.login === 'BnJm_K2sX' && password === 'R3yV8cDg') {
                    isAuthenticated = true;
                } else if (user.login === 'MlNd_5p3D' && password === 'A9xH1jFm') {
                    isAuthenticated = true;
                } else if (user.login === 'MxmL_7aJb' && password === 'S5uI6oPr') {
                    isAuthenticated = true;
                } else if (user.login === 'NlNe_B1vY' && password === 'W0cE3lXs') {
                    isAuthenticated = true;
                }
            }


            if (isAuthenticated) {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('currentArbiterLogin', user.login);
                sessionStorage.setItem('currentArbiterName', user.name);
                checkAuth();
            } else {
                errorMsg.textContent = 'Identifiant ou mot de passe incorrect.';
            }
        });

        function logout() {
            sessionStorage.clear();
            location.reload();
        }

        // --- 3. GESTION DES TH√àMES (Identique) ---

        function setTheme(themeName) {
            document.body.className = themeName + '-mode';
            localStorage.setItem('theme', themeName);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }


        // --- 4. GESTION DES √âQUIPES ET CONFIGURATION ---

        function getTeamList() {
            const savedTeams = JSON.parse(localStorage.getItem('teams'));
            let teams = savedTeams || INITIAL_TEAMS;
            teams = Array.from(new Set(teams)).sort();
            localStorage.setItem('teams', JSON.stringify(teams));
            return teams;
        }

        function getMatchHistory() {
            return JSON.parse(localStorage.getItem('matchHistory')) || [];
        }

        function updateTeamSelects() {
            const teams = getTeamList();
            const selectA = document.getElementById('teamA-select');
            const selectB = document.getElementById('teamB-select');
            
            selectA.innerHTML = '<option value="">-- Choisir une √©quipe --</option>';
            selectB.innerHTML = '<option value="">-- Choisir une √©quipe --</option>';
            
            teams.forEach(team => {
                const optionA = document.createElement('option');
                optionA.value = optionA.textContent = team;
                selectA.appendChild(optionA);

                const optionB = document.createElement('option');
                optionB.value = optionB.textContent = team;
                selectB.appendChild(optionB);
            });
        }
        
        // --- Randomisation Avanc√©e (Identique) ---
        function randomizeTeams() {
            const teams = getTeamList();
            const history = getMatchHistory();
            
            if (teams.length < 2) {
                alert("Ajoutez au moins deux √©quipes pour la randomisation.");
                return;
            }

            // 1. Compter les matchs jou√©s par chaque √©quipe
            const matchCounts = {};
            teams.forEach(team => matchCounts[team] = 0);

            history.forEach(match => {
                if (match.teamA) matchCounts[match.teamA] = (matchCounts[match.teamA] || 0) + 1;
                if (match.teamB) matchCounts[match.teamB] = (matchCounts[match.teamB] || 0) + 1;
            });

            // 2. Trier les √©quipes par nombre de matchs jou√©s (moins de matchs en premier)
            const sortedTeams = teams.sort((a, b) => matchCounts[a] - matchCounts[b]);

            // 3. S√©lectionner les deux √©quipes avec le moins de matchs jou√©s
            let teamA = sortedTeams[0];
            let teamB = sortedTeams[1];
            
            // Si les deux premi√®res √©quipes ont le m√™me nombre de matchs, on les m√©lange l√©g√®rement pour varier
            if (matchCounts[teamA] === matchCounts[teamB] && teams.length > 2) {
                 // S√©lectionner deux √©quipes al√©atoirement parmi celles ayant le nombre minimum de matchs
                const minCount = matchCounts[teamA];
                const leastPlayedTeams = teams.filter(t => matchCounts[t] === minCount);
                
                if (leastPlayedTeams.length >= 2) {
                    const randomIndex1 = Math.floor(Math.random() * leastPlayedTeams.length);
                    teamA = leastPlayedTeams[randomIndex1];
                    
                    let randomIndex2;
                    do {
                        randomIndex2 = Math.floor(Math.random() * leastPlayedTeams.length);
                    } while (randomIndex1 === randomIndex2);
                    
                    teamB = leastPlayedTeams[randomIndex2];
                }
            }


            // 4. Mettre √† jour les s√©lecteurs
            document.getElementById('teamA-select').value = teamA;
            document.getElementById('teamB-select').value = teamB;
        }

        function validateTeams() {
            const teamASelect = document.getElementById('teamA-select').value;
            const teamBSelect = document.getElementById('teamB-select').value;
            const teamACustom = document.getElementById('teamA-custom').value.trim();
            const teamBCustom = document.getElementById('teamB-custom').value.trim();

            let teamA = teamASelect || teamACustom;
            let teamB = teamBSelect || teamBCustom;

            if (!teamA || !teamB || teamA === teamB) {
                alert("Veuillez choisir ou saisir deux √©quipes diff√©rentes pour continuer.");
                return;
            }

            // Sauvegarder les nouvelles √©quipes
            if (teamACustom && !getTeamList().includes(teamACustom)) {
                let teams = getTeamList();
                teams.push(teamACustom);
                localStorage.setItem('teams', JSON.stringify(teams));
            }
            if (teamBCustom && !getTeamList().includes(teamBCustom)) {
                let teams = getTeamList();
                teams.push(teamBCustom);
                localStorage.setItem('teams', JSON.stringify(teams));
            }

            currentTeams.teamA = teamA;
            currentTeams.teamB = teamB;
            finalWinnerOverride = null;

            document.getElementById('config-section').style.display = 'none';
            document.getElementById('scoring-section').style.display = 'block';
            
            document.getElementById('match-display').textContent = `${teamA} vs ${teamB}`;
            document.getElementById('nameA-score').textContent = teamA;
            document.getElementById('nameB-score').textContent = teamB;
            
            document.getElementById('eq-name-A').textContent = teamA;
            document.getElementById('eq-name-B').textContent = teamB;

            generateScoreInputs('A');
            generateScoreInputs('B');
            
            document.getElementById('equality-resolution').style.display = 'none';
        }
        
        function togglePenaltyMenu(teamId) {
            const content = document.getElementById(`penalty-content-${teamId}`);
            content.classList.toggle('active');
        }


        // --- 5. LOGIQUE DE SCORING DYNAMIQUE (Mise √† jour pour la sym√©trie du temps) ---

        function generateScoreInputs(teamId) {
            const container = document.getElementById(`inputs${teamId}`);
            container.innerHTML = '';
            
            // --- NOUVEAUT√â : Affichage du Temps R√©alis√© des deux c√¥t√©s pour la sym√©trie ---
            const timeInputContainer = document.createElement('div');
            timeInputContainer.className = 'score-item';
            
            const isTeamA = teamId === 'A';
            // Seul l'input de l'√©quipe A est actif (modifiable)
            const inputDisabled = isTeamA ? '' : 'disabled'; 
            // L'input B a un ID diff√©rent pour la lecture et le ciblage
            const inputId = isTeamA ? 'time-input' : 'time-input-B-display'; 
            // Seul l'input A d√©clenche le recalcul des scores
            const onInputEvent = isTeamA ? `oninput="calculateScore('A'); calculateScore('B')"` : '';
            
            timeInputContainer.innerHTML = `
                <span>Temps R√©alis√© (s)</span>
                <input type="number" id="${inputId}" min="0" max="${MAX_TIME}" ${onInputEvent} value="${MAX_TIME}" ${inputDisabled}>
            `;
            container.appendChild(timeInputContainer);
            // -----------------------------------------------------------------
            
            SCORING_RULES.actions.forEach(rule => {
                const item = document.createElement('div');
                item.className = 'score-item';
                item.innerHTML = `
                    <span>${rule.label} (${rule.points} pts)</span>
                    <input type="checkbox" data-rule-id="${rule.id}" data-team="${teamId}" onchange="calculateScore('${teamId}')">
                `;
                container.appendChild(item);
            });
            
            const penaltyToggle = document.createElement('div');
            penaltyToggle.className = 'penalty-toggle';
            penaltyToggle.setAttribute('onclick', `togglePenaltyMenu('${teamId}')`);
            penaltyToggle.innerHTML = '<span>Afficher/Masquer les P√©nalit√©s</span>';
            container.appendChild(penaltyToggle);

            const penaltyContent = document.createElement('div');
            penaltyContent.className = 'penalty-content';
            penaltyContent.id = `penalty-content-${teamId}`;
            
            SCORING_RULES.penalties.forEach(rule => {
                const item = document.createElement('div');
                item.className = 'score-item';
                
                let inputHtml;
                if(rule.type === 'forfeit') {
                     inputHtml = `<input type="checkbox" data-rule-id="${rule.id}" data-team="${teamId}" onchange="handleForfeit('${teamId}')">`;
                } else if (rule.type === 'manual_penalty') {
                     inputHtml = `<input type="number" id="manual-${teamId}" min="${rule.min}" max="${rule.max}" value="0" oninput="calculateScore('${teamId}')">`;
                } else {
                     inputHtml = `<input type="checkbox" data-rule-id="${rule.id}" data-team="${teamId}" onchange="calculateScore('${teamId}')">`;
                }
                
                item.innerHTML = `
                    <span>${rule.label}</span>
                    ${inputHtml}
                `;
                penaltyContent.appendChild(item);
            });
            container.appendChild(penaltyContent);
            
            calculateScore(teamId);
            
            // Si c'est l'√©quipe B, s'assurer que sa valeur est synchronis√©e lors de la g√©n√©ration
            if (!isTeamA) {
                const teamBTimeDisplay = document.getElementById('time-input-B-display');
                const teamATimeInput = document.getElementById('time-input');
                if(teamBTimeDisplay && teamATimeInput) {
                    teamBTimeDisplay.value = teamATimeInput.value;
                }
            }
        }
        
        function handleForfeit(teamId) {
            const forfeitInput = document.querySelector(`#inputs${teamId} input[data-rule-id="forfeit"]`);
            // Exclure les champs de temps
            const inputs = document.querySelectorAll(`#inputs${teamId} input:not([data-rule-id="forfeit"]):not(#time-input):not(#time-input-B-display)`); 
            
            const isDisabled = forfeitInput.checked;
            
            inputs.forEach(input => {
                input.disabled = isDisabled;
                if (isDisabled) {
                    if (input.type === 'checkbox') input.checked = false;
                    if (input.type === 'number') input.value = 0;
                }
            });
            
            calculateScore(teamId);
        }

        function calculateScore(teamId) {
            let score = 0;
            // Toujours lire la valeur du temps depuis l'input de l'√©quipe A
            const timeInputA = document.getElementById('time-input'); 
            const timeValue = parseFloat(timeInputA ? timeInputA.value : MAX_TIME) || MAX_TIME;
            
            // --- NOUVEAUT√â : Synchroniser l'affichage du temps de l'√©quipe B ---
            const timeInputBDisplay = document.getElementById('time-input-B-display'); 
            if (timeInputBDisplay) {
                 timeInputBDisplay.value = timeValue;
            }
            // -----------------------------------------------------------------


            const teamInputs = document.querySelectorAll(`#inputs${teamId} input[type="checkbox"]:not([data-rule-id="forfeit"]), #inputs${teamId} input[type="number"]`);
            const forfeitInput = document.querySelector(`#inputs${teamId} input[data-rule-id="forfeit"]`);
            
            let isForfeit = forfeitInput ? forfeitInput.checked : false;
            
            teamInputs.forEach(input => {
                const ruleId = input.dataset.ruleId;
                
                // Ignorer l'input du temps (Team A est l'input principal, Team B est l'affichage)
                if (input.id === 'time-input' || input.id === 'time-input-B-display') return;
                
                if (input.type === 'checkbox' && input.checked) {
                    const rule = SCORING_RULES.actions.find(r => r.id === ruleId) || SCORING_RULES.penalties.find(r => r.id === ruleId);
                    if (rule) score += rule.points;
                } 
                
                if (input.id === `manual-${teamId}`) {
                    score += parseInt(input.value) || 0;
                }
            });

            if (!isForfeit && timeValue >= 0 && timeValue <= MAX_TIME) {
                let bonus = (MAX_TIME - timeValue) * 2;
                score += Math.min(bonus, MAX_BONUS);
            }
            
            if (isForfeit) {
                score = 0;
                document.getElementById(`currentScore${teamId}`).textContent = "FORFAIT (0 pts)";
            } else {
                document.getElementById(`currentScore${teamId}`).textContent = `${score} pts`;
            }

            document.getElementById(`currentScore${teamId}`).setAttribute('data-final-score', score);
            
            checkEquality();
        }

        // --- GESTION DE L'√âGALIT√â (Identique) ---
        function checkEquality() {
            const scoreA = parseInt(document.getElementById('currentScoreA').getAttribute('data-final-score')) || 0;
            const scoreB = parseInt(document.getElementById('currentScoreB').getAttribute('data-final-score')) || 0;
            const arbiterLogin = sessionStorage.getItem('currentArbiterLogin');
            const equalitySection = document.getElementById('equality-resolution');

            if (scoreA === scoreB && scoreA !== 0 && isSpecialArbiter(arbiterLogin)) {
                equalitySection.style.display = 'block';
            } else {
                equalitySection.style.display = 'none';
                finalWinnerOverride = null;
            }
        }
        
        function setEqualityWinner(winnerTeam) {
            if (winnerTeam === 'A') {
                finalWinnerOverride = currentTeams.teamA;
                alert(`${currentTeams.teamA} est d√©clar√© vainqueur suite √† l'√©galit√©.`);
            } else if (winnerTeam === 'B') {
                finalWinnerOverride = currentTeams.teamB;
                alert(`${currentTeams.teamB} est d√©clar√© vainqueur suite √† l'√©galit√©.`);
            } else {
                finalWinnerOverride = "√âgalit√©";
                alert(`Le match reste sur √âgalit√©.`);
            }
            document.getElementById('equality-resolution').style.display = 'none';
        }


        // --- 6. VALIDATION, SAUVEGARDE LOCALE ET WEBHOOK ---

        function getMatchData() {
            const scoreA = parseInt(document.getElementById('currentScoreA').getAttribute('data-final-score')) || 0;
            const scoreB = parseInt(document.getElementById('currentScoreB').getAttribute('data-final-score')) || 0;
            const teamA = currentTeams.teamA;
            const teamB = currentTeams.teamB;
            const timeUsed = document.getElementById('time-input') ? document.getElementById('time-input').value : 'N/A';
            const arbiterName = sessionStorage.getItem('currentArbiterName') || 'Arbitre Inconnu';
            
            let winner;
            if (finalWinnerOverride) {
                winner = finalWinnerOverride;
            } else {
                winner = scoreA > scoreB ? teamA : (scoreB > scoreA ? teamB : "√âgalit√©");
            }

            const isForfeitA = document.querySelector('#inputsA input[data-rule-id="forfeit"]') ? document.querySelector('#inputsA input[data-rule-id="forfeit"]').checked : false;
            const isForfeitB = document.querySelector('#inputsB input[data-rule-id="forfeit"]') ? document.querySelector('#inputsB input[data-rule-id="forfeit"]').checked : false;


            return {
                date: new Date().toLocaleString(),
                teamA: teamA,
                scoreA: isForfeitA ? 'FORFAIT' : scoreA,
                teamB: teamB,
                scoreB: isForfeitB ? 'FORFAIT' : scoreB,
                time: timeUsed,
                winner: winner,
                arbiter: arbiterName
            };
        }

        function validateAndSaveScore() {
            const matchResult = getMatchData();
            const { winner } = matchResult;

            if (!matchResult.teamA || !matchResult.teamB) {
                alert("Veuillez d'abord valider les √©quipes.");
                return;
            }

            // 1. Sauvegarde Locale
            let history = getMatchHistory();
            history.push(matchResult);
            localStorage.setItem('matchHistory', JSON.stringify(history));

            // 2. Envoi vers Discord Webhook
            sendToDiscord(matchResult);

            // 3. Mise √† jour de l'interface
            loadHistory();
            document.getElementById('validation-message').textContent = `R√©sultat valid√© et publi√© ! ${winner} a gagn√© (ou √âgalit√©).`;
            
            // R√©initialiser pour le match suivant
            setTimeout(() => {
                document.getElementById('scoring-section').style.display = 'none';
                document.getElementById('config-section').style.display = 'block';
                document.getElementById('teamA-custom').value = '';
                document.getElementById('teamB-custom').value = '';
                updateTeamSelects();
                document.getElementById('validation-message').textContent = '';
                currentTeams = { teamA: null, teamB: null };
                finalWinnerOverride = null;
            }, 3000);
        }

        function sendToDiscord(result) {
            const { teamA, scoreA, teamB, scoreB, winner, arbiter } = result;
            const color = winner === teamA ? 0x0064FF : (winner === teamB ? 0xFFC800 : 0xAAAAAA); 
            const winnerDisplay = winner === "√âgalit√©" ? "√âGALIT√â ! Le match est nul." : `üèÜ VAINQUEUR : ${winner} !`;
            const finalScoreA = typeof scoreA === 'string' ? scoreA : `${scoreA} points`;
            const finalScoreB = typeof scoreB === 'string' ? scoreB : `${scoreB} points`;


            const payload = {
                content: "@everyone", 
                embeds: [{
                    title: `R√©sultat Officiel : ${teamA} vs ${teamB}`,
                    description: winnerDisplay,
                    color: color,
                    fields: [
                        { name: `${teamA} (Bleue)`, value: `**${finalScoreA}**`, inline: true },
                        { name: `${teamB} (Vert)`, value: `**${finalScoreB}**`, inline: true },
                    ],
                    footer: {
                        text: `Arbitr√© par ${arbiter} | Temps : ${result.time}s | Enregistr√© le ${result.date}`
                    }
                }]
            };

            fetch(DISCORD_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    console.error("Erreur lors de l'envoi du Webhook Discord.");
                    // Non bloquant : alert("ERREUR : Le score a √©t√© enregistr√© localement, mais l'envoi sur Discord a √©chou√© (Code: " + response.status + ").");
                }
            })
            .catch(error => {
                console.error("Erreur r√©seau lors de l'envoi du Webhook:", error);
                // Non bloquant : alert("ERREUR R√âSEAU : Le score a √©t√© enregistr√© localement, mais l'envoi sur Discord a √©chou√©.");
            });
        }
        
        // --- Envoi de Message Manuel (Identique) ---
        function sendManualDiscordMessage() {
            const message = document.getElementById('manual-message').value.trim();
            const statusElement = document.getElementById('manual-message-status');
            const arbiterName = sessionStorage.getItem('currentArbiterName') || 'Arbitre Inconnu';

            if (!message) {
                statusElement.textContent = "Veuillez taper un message.";
                statusElement.className = 'error-message';
                return;
            }

            const payload = {
                content: `**Message manuel de l'Arbitre (${arbiterName})**:\n${message}`,
            };

            fetch(DISCORD_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (response.ok) {
                    statusElement.textContent = "Message envoy√© avec succ√®s √† Discord !";
                    statusElement.className = 'success-message';
                    document.getElementById('manual-message').value = '';
                } else {
                    statusElement.textContent = `√âchec de l'envoi (Code: ${response.status}).`;
                    statusElement.className = 'error-message';
                }
            })
            .catch(error => {
                statusElement.textContent = "Erreur r√©seau lors de l'envoi.";
                statusElement.className = 'error-message';
            });
        }
        
        // --- T√©l√©chargement du R√©sultat (.txt) (Identique) ---
        function downloadMatchResult() {
            const match = getMatchData();
            
            const content = `
--- R√âSULTAT DU MATCH ---
Date: ${match.date}
Arbitre: ${match.arbiter}
Temps R√©alis√©: ${match.time}s

√âquipe 1 (Bleue): ${match.teamA}
Score 1: ${match.scoreA}

√âquipe 2 (Vert): ${match.teamB}
Score 2: ${match.scoreB}

VAINQUEUR D√âCLAR√â: ${match.winner}
-------------------------
(Ceci est une sauvegarde locale des donn√©es du match.)
            `.trim();
            
            const filename = `Match_${match.teamA}_vs_${match.teamB}_${new Date().toISOString().slice(0, 10)}.txt`;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Fichier ${filename} t√©l√©charg√© !`);
        }


        // --- 7. GESTION DE L'HISTORIQUE (Identique) ---

        function loadHistory() {
            const history = getMatchHistory();
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '';

            history.slice().reverse().forEach(match => {
                const row = tbody.insertRow();
                row.insertCell().textContent = match.teamA;
                row.insertCell().textContent = match.scoreA;
                row.insertCell().textContent = match.teamB;
                row.insertCell().textContent = match.scoreB;
                row.insertCell().textContent = match.winner;
                row.insertCell().textContent = match.arbiter;
                row.insertCell().textContent = match.date.split(',')[0];
            });
        }

        function clearHistory() {
            if (confirm("√ätes-vous s√ªr de vouloir EFFACER TOUT l'historique des matchs ? Cette action est irr√©versible localement.")) {
                localStorage.removeItem('matchHistory');
                loadHistory();
                alert("Historique effac√©.");
            }
        }


        // --- 8. INITIALISATION DE L'APPLICATION (Identique) ---

        function initApp() {
            loadTheme();
            updateTeamSelects();
            loadHistory();
        }

        document.addEventListener('DOMContentLoaded', checkAuth);
        
        // --- S√âCURIT√â NAVIGATEUR (Identique) ---
        document.addEventListener('contextmenu', event => event.preventDefault());
        
        document.onkeydown = function(e) {
            if (e.key === 'F12' || e.keyCode === 123) { return false; }
            if (e.key === 'F11' || e.keyCode === 122) { e.preventDefault(); }
            if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'C' || e.key === 'J' || e.key === 'K')) { return false; }
        };
    </script>
</body>
</html>

